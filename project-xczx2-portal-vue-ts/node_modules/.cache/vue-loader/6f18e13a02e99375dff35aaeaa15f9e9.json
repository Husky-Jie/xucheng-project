{"remainingRequest":"D:\\itcast2022\\xc_edu3.0\\code_0\\project-xczx2-portal-vue-ts\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\itcast2022\\xc_edu3.0\\code_0\\project-xczx2-portal-vue-ts\\src\\module-entering\\pages\\entering\\components\\common-entering-step2-upload-image.vue?vue&type=script&lang=ts&","dependencies":[{"path":"D:\\itcast2022\\xc_edu3.0\\code_0\\project-xczx2-portal-vue-ts\\src\\module-entering\\pages\\entering\\components\\common-entering-step2-upload-image.vue","mtime":1661430573808},{"path":"D:\\itcast2022\\xc_edu3.0\\code_0\\project-xczx2-portal-vue-ts\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1660903053464},{"path":"D:\\itcast2022\\xc_edu3.0\\code_0\\project-xczx2-portal-vue-ts\\node_modules\\babel-loader\\lib\\index.js","mtime":1576202003988},{"path":"D:\\itcast2022\\xc_edu3.0\\code_0\\project-xczx2-portal-vue-ts\\node_modules\\ts-loader\\index.js","mtime":1660903053026},{"path":"D:\\itcast2022\\xc_edu3.0\\code_0\\project-xczx2-portal-vue-ts\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1660903053464},{"path":"D:\\itcast2022\\xc_edu3.0\\code_0\\project-xczx2-portal-vue-ts\\node_modules\\vue-loader\\lib\\index.js","mtime":1660903053930}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoNCmltcG9ydCB7IENvbXBvbmVudCwgVnVlLCBQcm9wU3luYywgV2F0Y2ggfSBmcm9tICd2dWUtcHJvcGVydHktZGVjb3JhdG9yJw0KaW1wb3J0IHsNCiAgRWxVcGxvYWRJbnRlcm5hbFJhd0ZpbGUsDQogIEVsVXBsb2FkSW50ZXJuYWxGaWxlRGV0YWlsLA0KICBIdHRwUmVxdWVzdE9wdGlvbnMNCn0gZnJvbSAnZWxlbWVudC11aS90eXBlcy91cGxvYWQnDQppbXBvcnQgKiBhcyBxaW5pdSBmcm9tICdxaW5pdS1qcycNCmltcG9ydCB7IElRblBhcmFtc0RUTyB9IGZyb20gJ0AvZW50aXR5L21lZGlhLXBhZ2UtbGlzdCcNCmltcG9ydCB7IGdldFFuUGFyYW1zIH0gZnJvbSAnQC9hcGkvY29tbW9uJw0KDQpAQ29tcG9uZW50DQpleHBvcnQgZGVmYXVsdCBjbGFzcyBDb21tb25FbnRlcmluZ1N0ZXAyVXBsb2FkSW1hZ2UgZXh0ZW5kcyBWdWUgew0KICBwcml2YXRlIGRpYWxvZ1Zpc2libGU6IGJvb2xlYW4gPSBmYWxzZQ0KDQogIEBQcm9wU3luYygnaW1hZ2VVcmwnLCB7IHR5cGU6IFN0cmluZywgcmVxdWlyZWQ6IGZhbHNlLCBkZWZhdWx0OiAnJyB9KQ0KICBzeW5jZWRJbWFnZVVybCE6IHN0cmluZw0KDQogIEBXYXRjaCgnc3luY2VkSW1hZ2VVcmwnKQ0KICBvbkltYWdlVXJsQ2hhbmdlZChuZXdJbWFnZVVybDogc3RyaW5nLCBvbGRJbWFnZVVybDogc3RyaW5nKSB7DQogICAgLy8gY29uc29sZS5sb2coJy0tLS0tLS0tLS0tLS0tb25JbWFnZVVybENoYW5nZWTliY0tLS0tLS0tLS0tLS0tLScpDQogICAgLy8gY29uc29sZS5sb2codGhpcy5maWxlTGlzdCkNCiAgICBpZiAobmV3SW1hZ2VVcmwpIHsNCiAgICAgIHRoaXMuZmlsZUxpc3QgPSBbeyB1cmw6IG5ld0ltYWdlVXJsIH1dDQogICAgfSBlbHNlIHsNCiAgICAgIHRoaXMuZmlsZUxpc3QgPSBbXQ0KICAgIH0NCiAgICAvL+ino+WGs+WbnumAgOWIsOS4iuS4gOmhtei3r+W+hOWJjee8gOa2iOWksemXrumimA0KICAgIC8vIGlmKHRoaXMuc3luY2VkSW1hZ2VVcmwubGVuZ3RoPjAgJiYgdGhpcy5zeW5jZWRJbWFnZVVybC5pbmRleE9mKGAke3Byb2Nlc3MuZW52LlZVRV9BUFBfU0VSVkVSX1BJQ1NFUlZFUl9VUkx9YCk8MCl7DQogICAgICANCiAgICAvLyAgIHRoaXMuc3luY2VkSW1hZ2VVcmwgPSBgJHtwcm9jZXNzLmVudi5WVUVfQVBQX1NFUlZFUl9QSUNTRVJWRVJfVVJMfWArdGhpcy5zeW5jZWRJbWFnZVVybDsNCiAgICAvLyAgIGFsZXJ0KHRoaXMuc3luY2VkSW1hZ2VVcmwpDQogICAgLy8gfQ0KICAgIC8vIGNvbnNvbGUubG9nKCctLS0tLS0tLS0tLS0tLW9uSW1hZ2VVcmxDaGFuZ2Vk5ZCOLS0tLS0tLS0tLS0tLS0nKQ0KICAgIC8vIGNvbnNvbGUubG9nKHRoaXMuZmlsZUxpc3QpDQogIH0NCg0KICBwcml2YXRlIGZpbGVMaXN0OiBhbnlbXSA9IFtdDQoNCiAgLy8gY29tcHV0ZWQNCiAgZ2V0IHVwbG9hZERpc2FibGVkKCkgew0KICAgIHJldHVybiB0aGlzLmZpbGVMaXN0Lmxlbmd0aCA+IDANCiAgfQ0KDQogIC8qKg0KICAgKiDkuIrkvKDmlofku7bkuYvliY3nmoTpkqnlrZANCiAgICogVE9ETzog5aKe5Yqg5YW25LuW5paH5Lu25qC85byPDQogICAqLw0KICBwcml2YXRlIGhhbmRsZUJlZm9yZVVwbG9hZChmaWxlOiBFbFVwbG9hZEludGVybmFsUmF3RmlsZSkgew0KICAgIGNvbnN0IGlzSlBHID0NCiAgICAgIGZpbGUudHlwZSA9PT0gJ2ltYWdlL2pwZWcnIHx8DQogICAgICBmaWxlLnR5cGUgPT09ICdpbWFnZS9wbmcnIHx8DQogICAgICBmaWxlLnR5cGUgPT09ICdpbWFnZS9ibXAnDQogICAgY29uc3QgaXNMdDJNID0gZmlsZS5zaXplIC8gMTAyNCAvIDEwMjQgPCAyDQoNCiAgICBpZiAoIWlzSlBHKSB7DQogICAgICB0aGlzLiRtZXNzYWdlLmVycm9yKCfkuIrkvKDlpLTlg4/lm77niYflj6rog73mmK8gSlBHL1BORy9CTVAg5qC85byPIScpDQogICAgfQ0KICAgIGlmICghaXNMdDJNKSB7DQogICAgICB0aGlzLiRtZXNzYWdlLmVycm9yKCfkuIrkvKDlpLTlg4/lm77niYflpKflsI/kuI3og73otoXov4cgMk1CIScpDQogICAgfQ0KICAgIHJldHVybiBpc0pQRyAmJiBpc0x0Mk0NCiAgfQ0KICAvKioNCiAgICog5LiK5Lyg5oiQ5Yqf6ZKp5a2QDQogICAqLw0KICBwcml2YXRlIGhhbmRsZVVwbG9hZFN1Y2Nlc3MocmVzLGZpbGUpew0KICAgICAgdGhpcy5zeW5jZWRJbWFnZVVybCA9IGAke3Byb2Nlc3MuZW52LlZVRV9BUFBfU0VSVkVSX1BJQ1NFUlZFUl9VUkx9YCtyZXMuZmlsZW5hbWUNCiAgICAgIGNvbnNvbGUubG9nKHJlcy5tc2crcmVzLmZpbGVuYW1lKQ0KICAgICAgaWYocmVzLmNvZGU9PTEpew0KICAgICAgICB0aGlzLiRtZXNzYWdlLmVycm9yKHJlcy5tc2cpDQogICAgICB9DQogIH0NCiAgLyoqDQogICAqIOaWh+S7tuS4iuS8oOWksei0pemSqeWtkA0KICAgKi8NCg0KICBwcml2YXRlIGhhbmRsZVVwbG9hZEVycm9yKGVycil7DQogICAgY29uc29sZS5sb2coJ+S4iuS8oOWksei0pTonK2VycikNCiAgfQ0KICAvKioNCiAgICog6KaG55uW6buY6K6k55qE5LiK5Lyg6KGM5Li6DQogICAqLw0KICBwcml2YXRlIGhhbmRsZUh0dHBSZXF1ZXN0KG9wdGlvbnM6IEh0dHBSZXF1ZXN0T3B0aW9ucykgew0KICAgIGxldCBmaWxlID0gb3B0aW9ucy5maWxlDQogICAgbGV0IGZpbGVuYW1lID0gZmlsZS5uYW1lDQogICAgbGV0IGluZGV4ID0gZmlsZW5hbWUubGFzdEluZGV4T2YoJy4nKQ0KICAgIGxldCBzdWZmaXggPSBmaWxlbmFtZS5zdWJzdHIoaW5kZXgpDQoNCiAgICAvLyDmlofmoaPkuIrkvKDliLDkuIPniZvkupENCiAgICB0aGlzLnFpbml1eXVuVXBsb2FkKGZpbGUpDQogIH0NCg0KICAvKioNCiAgICog5paH5qGj5LiK5Lyg5Yiw5LiD54mb5LqRDQogICAqIFRPRE86IOW8guW4uOezu+iAg+iZkSA0MDENCiAgICogVE9ETzog5ZCO56uv5o+Q5L6b5YWs5byA6LWE5rqQ5o6l5Y+jDQogICAqLw0KICBwcml2YXRlIGFzeW5jIHFpbml1eXVuVXBsb2FkKGZpbGU6IEVsVXBsb2FkSW50ZXJuYWxGaWxlRGV0YWlsKSB7DQogICAgLy8g5YeG5aSH5bel5L2cDQogICAgbGV0IHFuUGFyYW1zOiBJUW5QYXJhbXNEVE8gPSBhd2FpdCBnZXRRblBhcmFtcygpDQoNCiAgICAvLyDlvIDlp4vkuIrkvKANCiAgICBsZXQgdG9rZW4gPSBxblBhcmFtcy5xblRva2VuDQogICAgbGV0IGNvbmZpZyA9IHsNCiAgICAgIHVzZUNkbkRvbWFpbjogdHJ1ZSwNCiAgICAgIHJlZ2lvbjogbnVsbCAvLyDoh6rliqjliIbmnpDkuIrkvKDln5/lkI3ljLrln58NCiAgICB9DQogICAgbGV0IHB1dEV4dHJhID0gew0KICAgICAgZm5hbWU6ICcnLA0KICAgICAgcGFyYW1zOiB7fSwNCiAgICAgIG1pbWVUeXBlOiBudWxsDQogICAgfQ0KICAgIGxldCBrZXkgPSBxblBhcmFtcy5rZXkNCg0KICAgIGxldCBuZXh0ID0gcmVzcG9uc2UgPT4gew0KICAgICAgbGV0IHRvdGFsID0gcmVzcG9uc2UudG90YWwNCiAgICAgIGxldCBwZXJjZW50YWdlID0gTWF0aC5jZWlsKHRvdGFsLnBlcmNlbnQpDQogICAgICBjb25zb2xlLmxvZyhg5aqS6LWE5LiK5Lyg5Yiw5LiD54mb5LqR6L+b5bqmLi4uJHtwZXJjZW50YWdlfSVgKQ0KICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UpDQogICAgfQ0KICAgIGxldCBlcnJvciA9IHJlc3BvbnNlID0+IHsNCiAgICAgIGNvbnNvbGUubG9nKCflqpLotYTkuIrkvKDliLDkuIPniZvkupHlpLHotKUuLi4nKQ0KICAgICAgY29uc29sZS5sb2cocmVzcG9uc2UpDQogICAgfQ0KICAgIGxldCBjb21wbGV0ZSA9IHJlc3BvbnNlID0+IHsNCiAgICAgIHRoaXMuc3luY2VkSW1hZ2VVcmwgPSBgaHR0cDovLyR7cW5QYXJhbXMuZG9tYWlufS8ke3FuUGFyYW1zLmtleX1gDQogICAgICBjb25zb2xlLmxvZygn5aqS6LWE5LiK5Lyg5Yiw5LiD54mb5LqR5a6M5oiQLi4uJykNCiAgICAgIGNvbnNvbGUubG9nKHJlc3BvbnNlKQ0KICAgIH0NCg0KICAgIGxldCBzdWJzY3JpcHRpb24NCiAgICAvLyDosIPnlKhzZGvkuIrkvKDmjqXlj6Pojrflvpfnm7jlupTnmoRvYnNlcnZhYmxl77yM5o6n5Yi25LiK5Lyg5ZKM5pqC5YGcDQogICAgbGV0IG9ic2VydmFibGUgPSBxaW5pdS51cGxvYWQoZmlsZSwga2V5LCB0b2tlbiwgcHV0RXh0cmEsIGNvbmZpZykNCiAgICBvYnNlcnZhYmxlLnN1YnNjcmliZShuZXh0LCBlcnJvciwgY29tcGxldGUpDQogICAgY29uc29sZS5sb2coJ+Wqkui1hOS4iuS8oOWIsOS4g+eJm+S6keW8gOWniy4uLicpDQogIH0NCg0KICAvKioNCiAgICog54K55Ye75paH5Lu25YiX6KGo5Lit5bey5LiK5Lyg55qE5paH5Lu25pe255qE6ZKp5a2QDQogICAqLw0KICBwcml2YXRlIGhhbmRsZU9uUHJldmlldyhmaWxlOiBFbFVwbG9hZEludGVybmFsRmlsZURldGFpbCkgew0KICAgIHRoaXMuZGlhbG9nVmlzaWJsZSA9IHRydWUNCiAgfQ0KDQogIC8qKg0KICAgKiDmlofku7bliJfooajnp7vpmaTmlofku7bml7bnmoTpkqnlrZANCiAgICovDQogIHByaXZhdGUgaGFuZGxlT25SZW1vdmUoDQogICAgZmlsZTogRWxVcGxvYWRJbnRlcm5hbEZpbGVEZXRhaWwsDQogICAgZmlsZUxpc3Q6IEVsVXBsb2FkSW50ZXJuYWxGaWxlRGV0YWlsW10NCiAgKSB7DQogICAgdGhpcy5zeW5jZWRJbWFnZVVybCA9ICcnDQogIH0NCn0NCg=="},{"version":3,"sources":["common-entering-step2-upload-image.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA8BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"common-entering-step2-upload-image.vue","sourceRoot":"src/module-entering/pages/entering/components","sourcesContent":["<template>\r\n  <div>\r\n    <el-upload\r\n      action\r\n      list-type=\"picture-card\"\r\n      accept=\".jpg, .png, .bmp\"\r\n      :file-list=\"fileList\"\r\n      :before-upload=\"handleBeforeUpload\"\r\n      :on-success=\"handleUploadSuccess\"\r\n      :on-error=\"handleUploadError\"\r\n      action=\"/api/media/upload_pic\"\r\n      name=\"Filedata\"\r\n      :on-preview=\"handleOnPreview\"\r\n      :on-remove=\"handleOnRemove\"\r\n      :class=\"{disabled:uploadDisabled}\"\r\n    >\r\n      <i class=\"el-icon-plus\"></i>\r\n      <div class=\"el-upload__tip\" slot=\"tip\" style=\"line-height: 20px;\">\r\n        <slot></slot>\r\n        <br />文件小于2M\r\n        <br />支持JPG/PNG/BMP等格式图片\r\n      </div>\r\n    </el-upload>\r\n    <el-dialog :visible.sync=\"dialogVisible\">\r\n      <img width=\"100%\" :src=\"syncedImageUrl\" alt />\r\n    </el-dialog>\r\n  </div>\r\n</template>\r\n\r\n<script lang=\"ts\">\r\nimport { Component, Vue, PropSync, Watch } from 'vue-property-decorator'\r\nimport {\r\n  ElUploadInternalRawFile,\r\n  ElUploadInternalFileDetail,\r\n  HttpRequestOptions\r\n} from 'element-ui/types/upload'\r\nimport * as qiniu from 'qiniu-js'\r\nimport { IQnParamsDTO } from '@/entity/media-page-list'\r\nimport { getQnParams } from '@/api/common'\r\n\r\n@Component\r\nexport default class CommonEnteringStep2UploadImage extends Vue {\r\n  private dialogVisible: boolean = false\r\n\r\n  @PropSync('imageUrl', { type: String, required: false, default: '' })\r\n  syncedImageUrl!: string\r\n\r\n  @Watch('syncedImageUrl')\r\n  onImageUrlChanged(newImageUrl: string, oldImageUrl: string) {\r\n    // console.log('--------------onImageUrlChanged前--------------')\r\n    // console.log(this.fileList)\r\n    if (newImageUrl) {\r\n      this.fileList = [{ url: newImageUrl }]\r\n    } else {\r\n      this.fileList = []\r\n    }\r\n    //解决回退到上一页路径前缀消失问题\r\n    // if(this.syncedImageUrl.length>0 && this.syncedImageUrl.indexOf(`${process.env.VUE_APP_SERVER_PICSERVER_URL}`)<0){\r\n      \r\n    //   this.syncedImageUrl = `${process.env.VUE_APP_SERVER_PICSERVER_URL}`+this.syncedImageUrl;\r\n    //   alert(this.syncedImageUrl)\r\n    // }\r\n    // console.log('--------------onImageUrlChanged后--------------')\r\n    // console.log(this.fileList)\r\n  }\r\n\r\n  private fileList: any[] = []\r\n\r\n  // computed\r\n  get uploadDisabled() {\r\n    return this.fileList.length > 0\r\n  }\r\n\r\n  /**\r\n   * 上传文件之前的钩子\r\n   * TODO: 增加其他文件格式\r\n   */\r\n  private handleBeforeUpload(file: ElUploadInternalRawFile) {\r\n    const isJPG =\r\n      file.type === 'image/jpeg' ||\r\n      file.type === 'image/png' ||\r\n      file.type === 'image/bmp'\r\n    const isLt2M = file.size / 1024 / 1024 < 2\r\n\r\n    if (!isJPG) {\r\n      this.$message.error('上传头像图片只能是 JPG/PNG/BMP 格式!')\r\n    }\r\n    if (!isLt2M) {\r\n      this.$message.error('上传头像图片大小不能超过 2MB!')\r\n    }\r\n    return isJPG && isLt2M\r\n  }\r\n  /**\r\n   * 上传成功钩子\r\n   */\r\n  private handleUploadSuccess(res,file){\r\n      this.syncedImageUrl = `${process.env.VUE_APP_SERVER_PICSERVER_URL}`+res.filename\r\n      console.log(res.msg+res.filename)\r\n      if(res.code==1){\r\n        this.$message.error(res.msg)\r\n      }\r\n  }\r\n  /**\r\n   * 文件上传失败钩子\r\n   */\r\n\r\n  private handleUploadError(err){\r\n    console.log('上传失败:'+err)\r\n  }\r\n  /**\r\n   * 覆盖默认的上传行为\r\n   */\r\n  private handleHttpRequest(options: HttpRequestOptions) {\r\n    let file = options.file\r\n    let filename = file.name\r\n    let index = filename.lastIndexOf('.')\r\n    let suffix = filename.substr(index)\r\n\r\n    // 文档上传到七牛云\r\n    this.qiniuyunUpload(file)\r\n  }\r\n\r\n  /**\r\n   * 文档上传到七牛云\r\n   * TODO: 异常系考虑 401\r\n   * TODO: 后端提供公开资源接口\r\n   */\r\n  private async qiniuyunUpload(file: ElUploadInternalFileDetail) {\r\n    // 准备工作\r\n    let qnParams: IQnParamsDTO = await getQnParams()\r\n\r\n    // 开始上传\r\n    let token = qnParams.qnToken\r\n    let config = {\r\n      useCdnDomain: true,\r\n      region: null // 自动分析上传域名区域\r\n    }\r\n    let putExtra = {\r\n      fname: '',\r\n      params: {},\r\n      mimeType: null\r\n    }\r\n    let key = qnParams.key\r\n\r\n    let next = response => {\r\n      let total = response.total\r\n      let percentage = Math.ceil(total.percent)\r\n      console.log(`媒资上传到七牛云进度...${percentage}%`)\r\n      console.log(response)\r\n    }\r\n    let error = response => {\r\n      console.log('媒资上传到七牛云失败...')\r\n      console.log(response)\r\n    }\r\n    let complete = response => {\r\n      this.syncedImageUrl = `http://${qnParams.domain}/${qnParams.key}`\r\n      console.log('媒资上传到七牛云完成...')\r\n      console.log(response)\r\n    }\r\n\r\n    let subscription\r\n    // 调用sdk上传接口获得相应的observable，控制上传和暂停\r\n    let observable = qiniu.upload(file, key, token, putExtra, config)\r\n    observable.subscribe(next, error, complete)\r\n    console.log('媒资上传到七牛云开始...')\r\n  }\r\n\r\n  /**\r\n   * 点击文件列表中已上传的文件时的钩子\r\n   */\r\n  private handleOnPreview(file: ElUploadInternalFileDetail) {\r\n    this.dialogVisible = true\r\n  }\r\n\r\n  /**\r\n   * 文件列表移除文件时的钩子\r\n   */\r\n  private handleOnRemove(\r\n    file: ElUploadInternalFileDetail,\r\n    fileList: ElUploadInternalFileDetail[]\r\n  ) {\r\n    this.syncedImageUrl = ''\r\n  }\r\n}\r\n</script>\r\n\r\n<style lang=\"scss\">\r\n.disabled .el-upload--picture-card {\r\n  display: none;\r\n}\r\n</style>"]}]}